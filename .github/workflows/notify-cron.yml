name: ğŸ”” Notify Worker Cron

on:
  schedule:
    # æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    - cron: '*/5 * * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (dry run)'
        required: false
        default: 'false'
        type: boolean

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ è§¦å‘é€šçŸ¥å·¥ä½œå™¨
        id: trigger_notify
        run: |
          echo "ğŸ• å¼€å§‹æ‰§è¡Œé€šçŸ¥ä»»åŠ¡: $(date)"
          
          # æ„å»ºè¯·æ±‚URLå’Œheaders
          SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          CRON_SECRET="${{ secrets.CRON_SECRET }}"
          
          # æ£€æŸ¥å¿…è¦å‚æ•°
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ] || [ -z "$CRON_SECRET" ]; then
            echo "âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡"
            echo "SUPABASE_URL: ${SUPABASE_URL:0:20}..."
            echo "SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:0:20}..."
            echo "CRON_SECRET: ${CRON_SECRET:0:20}..."
            exit 1
          fi
          
          # å‘é€è¯·æ±‚
          echo "ğŸ“¡ å‘é€è¯·æ±‚åˆ°: $SUPABASE_URL/functions/v1/notify-worker"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "$SUPABASE_URL/functions/v1/notify-worker" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "x-cron-secret: $CRON_SECRET" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Notify-Cron/1.0")
          
          # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "ğŸ“Š HTTPçŠ¶æ€ç : $HTTP_STATUS"
          echo "ğŸ“„ å“åº”å†…å®¹: $RESPONSE_BODY"
          
          # æ£€æŸ¥å“åº”çŠ¶æ€
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… é€šçŸ¥ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ é€šçŸ¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥ (HTTP $HTTP_STATUS)"
            echo "result=failed" >> $GITHUB_OUTPUT
            echo "status_code=$HTTP_STATUS" >> $GITHUB_OUTPUT
          fi
          
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
      
      - name: ğŸ“Š è®°å½•æ‰§è¡Œç»“æœ
        if: always()
        run: |
          echo "ğŸ“‹ ä»»åŠ¡æ‰§è¡Œæ‘˜è¦:"
          echo "  æ‰§è¡Œæ—¶é—´: $(date)"
          echo "  æ‰§è¡Œç»“æœ: ${{ steps.trigger_notify.outputs.result }}"
          if [ "${{ steps.trigger_notify.outputs.status_code }}" != "" ]; then
            echo "  HTTPçŠ¶æ€: ${{ steps.trigger_notify.outputs.status_code }}"
          fi
          echo "  å·¥ä½œæµID: ${{ github.run_id }}"
          echo "  æäº¤SHA: ${{ github.sha }}"
      
      - name: ğŸš¨ å¤±è´¥é€šçŸ¥ (å¯é€‰)
        if: failure()
        run: |
          echo "âŒ é€šçŸ¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          echo "ğŸ” æŸ¥çœ‹å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šé€šçŸ¥é€»è¾‘ï¼Œæ¯”å¦‚ï¼š
          # - å‘é€Slacké€šçŸ¥
          # - å‘é€Discordé€šçŸ¥
          # - å‘é€é‚®ä»¶é€šçŸ¥
          # - åˆ›å»ºGitHub Issue
      
      - name: âœ… æˆåŠŸé€šçŸ¥ (å¯é€‰)
        if: success()
        run: |
          echo "ğŸ‰ é€šçŸ¥ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
          echo "ğŸ“Š æŸ¥çœ‹å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

